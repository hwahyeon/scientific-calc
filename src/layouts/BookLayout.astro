---
import "../styles/global.css";
import type { CollectionEntry } from "astro:content";

type Lang = "ko" | "en";
type AnyChapter = CollectionEntry<"koBook"> | CollectionEntry<"enBook">;

const {
  lang,
  chapters,
  currentPath,
  siteTitle = "공학용 계산기 실전 가이드",
  pageTitle,
  description,
} = Astro.props as {
  lang: Lang;
  chapters: AnyChapter[];
  currentPath: string;
  siteTitle?: string;
  pageTitle?: string;
  description?: string;
};

const otherLang: Lang = lang === "ko" ? "en" : "ko";
const otherLangPath = currentPath.replace(/^\/(ko|en)\//, `/${otherLang}/`);

const items = [...chapters]
  .filter((c) => !c.data?.draft)
  .sort((a, b) => (a.data?.order ?? 0) - (b.data?.order ?? 0));

const isActive = (slug: string) => currentPath.startsWith(`/${lang}/book/${slug}`);
---

<html lang={lang} class="h-full">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light dark" />

    <title>
      {pageTitle ? `${pageTitle} · ${siteTitle}` : siteTitle}
    </title>

    <meta
      name="description"
      content={
        description ??
        (lang === "ko"
          ? "공학용 계산기 실전 가이드 웹북"
          : "Scientific calculator practical guide web book")
      }
    />

    <meta
      property="og:title"
      content={pageTitle ? `${pageTitle} · ${siteTitle}` : siteTitle}
    />

    <meta
      property="og:description"
      content={
        description ??
        (lang === "ko"
          ? "공학용 계산기 실전 가이드 웹북"
          : "Scientific calculator practical guide web book")
      }
    />

    <meta property="og:type" content="website" />

    <!-- Apply initial theme before paint -->
    <script is:inline>
      (function () {
        const key = "theme";
        const saved = localStorage.getItem(key);
        const prefersDark =
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches;

        const theme = saved ?? (prefersDark ? "dark" : "light");
        document.documentElement.classList.toggle("dark", theme === "dark");
      })();
    </script>
  </head>

  <body class="h-full bg-neutral-50 text-neutral-900 antialiased dark:bg-neutral-900 dark:text-neutral-100">
    <div class="mx-auto grid min-h-screen max-w-6xl grid-cols-1 md:grid-cols-[280px_1fr]">
      <!-- Sidebar (desktop) -->
      <aside class="hidden md:block border-r border-neutral-200 bg-white/70 backdrop-blur dark:border-neutral-800 dark:bg-neutral-900/60">
        <div class="sticky top-0 p-4">
          <a href={`/${lang}/book/`} class="text-sm font-semibold tracking-tight">
            {siteTitle}
          </a>

          <div class="mt-4 text-xs font-medium text-neutral-500 dark:text-neutral-400">
            {lang === "ko" ? "목차" : "Table of contents"}
          </div>

          <nav class="mt-2">
            <ul class="space-y-1">
              {items.map((c) => (
                <li>
                  <a
                    href={`/${lang}/book/${c.slug}/`}
                    class:list={[
                      "block rounded-md px-3 py-2 text-sm transition",
                      "hover:bg-neutral-100 dark:hover:bg-neutral-800/60",
                      isActive(c.slug)
                        ? "bg-neutral-100 dark:bg-neutral-800/60"
                        : "bg-transparent",
                    ]}
                  >
                    {c.data?.title}
                  </a>
                </li>
              ))}
            </ul>
          </nav>
        </div>
      </aside>

      <!-- Main -->
      <div class="min-h-screen">
        <header class="sticky top-0 z-10 border-b border-neutral-200 bg-white/70 backdrop-blur dark:border-neutral-800 dark:bg-neutral-900/60">
          <div class="mx-auto flex max-w-6xl items-center justify-between px-4 py-3 md:justify-end">
            <!-- Mobile TOC -->
            <details class="md:hidden">
              <summary class="cursor-pointer select-none rounded-md border border-neutral-200 px-3 py-1.5 text-sm hover:bg-neutral-100 dark:border-neutral-800 dark:hover:bg-neutral-800/60">
                {lang === "ko" ? "목차" : "TOC"}
              </summary>

              <nav class="mt-2 rounded-md border border-neutral-200 bg-white p-2 dark:border-neutral-800 dark:bg-neutral-900">
                <ul class="space-y-1">
                  {items.map((c) => (
                    <li>
                      <a
                        href={`/${lang}/book/${c.slug}/`}
                        class:list={[
                          "block rounded-md px-3 py-2 text-sm",
                          "hover:bg-neutral-100 dark:hover:bg-neutral-800/60",
                          isActive(c.slug)
                            ? "bg-neutral-100 dark:bg-neutral-800/60"
                            : "bg-transparent",
                        ]}
                      >
                        {c.data?.title}
                      </a>
                    </li>
                  ))}
                </ul>
              </nav>
            </details>

            <div class="flex items-center gap-2">
              <!-- Language toggle -->
              <a
                class="rounded-md border border-neutral-200 px-3 py-1.5 text-sm hover:bg-neutral-100 dark:border-neutral-800 dark:hover:bg-neutral-800/60"
                href={otherLangPath}
                title="Switch language"
              >
                {lang === "ko" ? "EN" : "KO"}
              </a>

              <!-- Theme toggle -->
              <button
                id="themeToggle"
                type="button"
                class="rounded-md border border-neutral-200 px-3 py-1.5 text-sm hover:bg-neutral-100 dark:border-neutral-800 dark:hover:bg-neutral-800/60"
                title="Toggle theme"
              >
                Theme
              </button>

              <script is:inline>
                (function () {
                  const key = "theme";
                  const btn = document.getElementById("themeToggle");
                  if (!btn) return;

                  btn.addEventListener("click", () => {
                    const isDark = document.documentElement.classList.toggle("dark");
                    localStorage.setItem(key, isDark ? "dark" : "light");
                  });
                })();
              </script>
            </div>
          </div>
        </header>

        <main class="px-4 py-8">
          <div class="mx-auto w-full max-w-3xl">
            <slot />
          </div>
        </main>

        <footer class="border-t border-neutral-200 px-4 py-6 text-xs text-neutral-500 dark:border-neutral-800 dark:text-neutral-400">
          <div class="mx-auto max-w-3xl">{siteTitle}</div>
        </footer>
      </div>
    </div>
  </body>
</html>
